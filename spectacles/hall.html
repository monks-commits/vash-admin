<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Схема зала</title>
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @media (max-width: 640px){ :root { --seat: 22px; --gap: 4px; } }
    .controls{position:sticky; top:0; z-index:5; background:#fff; padding:8px 0; margin:-8px 0 8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; border-bottom:1px solid #eee;}
    .controls .btn { padding: 6px 10px; font-size: 14px; }
    .controls .meta { font-size: 13px; color: #666; }
    .hall-wrap{ overflow:auto; border:1px dashed #ddd; border-radius:12px; padding:12px; max-height:72vh; background:#fff; width:100%; }
    .hall{ display:grid; gap: var(--gap); justify-content:flex-start; grid-template-columns: repeat(var(--cols, 10), var(--seat)); transform-origin: top left; }
    .seat{ width: var(--seat); height: var(--seat); border-radius:6px; background:#e0e0e0; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; font-size: 12px; user-select: none; }
    .seat.selected{ background:#4caf50; color:#fff }
    .seat.reserved{ background:#9e9e9e; color:#fff; cursor:not-allowed }
    .spacer{ width: var(--seat); height: var(--seat); opacity:0; pointer-events:none }
    .rowlabel{ grid-column:1/-1; text-align:center; color:#666; margin-top:4px; font-size:12px }
    .legend { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .legend .item { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #eee; border-radius:8px; font-size:13px; }
    .legend .swatch { width:16px; height:16px; border-radius:4px; border:1px solid #ddd; }
    .seat.available{ background:#dbeafe }
    .p-220{ background:#93c5fd } .p-200{ background:#60a5fa }
    .p-190{ background:#a78bfa } .p-180{ background:#8b5cf6 }
    .p-170{ background:#fbbf24 } .p-160{ background:#a78bfa }
    .p-150{ background:#38bdf8 } .p-140{ background:#6b7280; color:#fff }
    .p-130{ background:#10b981 } .p-120{ background:#86efac }
    .p-100{ background:#60a5fa } .p-90{ background:#86efac }
    .p-80{ background:#a78bfa } .p-70{ background:#166534; color:#fff }
    .error { padding:12px; border:1px solid #fca5a5; background:#fee2e2; color:#7f1d1d; border-radius:10px; margin:10px 0; }

    /* боковые ложи */
    .side-sections{display:flex; gap:16px; margin-top:16px; flex-wrap:wrap}
    .side{flex:1 1 320px; border:1px dashed #ddd; border-radius:12px; padding:12px; background:#fff}
    .side h3{margin:0 0 8px 0; font-size:16px}
    .mini-hall{display:grid; gap: var(--gap); grid-template-columns: repeat(var(--mini-cols, 8), var(--seat))}
    .mini-rowlabel{grid-column:1/-1; text-align:center; color:#666; font-size:12px; margin-top:4px}
  </style>
</head>
<body>

  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <img src="../images/logo-placeholder.png" alt="Ваш Адмін">
        <div>
          <h1>Ваш Адмін</h1>
          <p class="tagline">Квитки без комісій. Дніпро • Кривий Ріг</p>
        </div>
      </div>
      <nav class="nav">
        <a href="../index.html">Головна</a>
        <a class="active" href="../afisha.html">Афіша</a>
        <a href="../theatres.html">Театри</a>
        <a href="../about.html">Про нас</a>
        <a href="../contacts.html">Контакти</a>
      </nav>
      <div class="social-icons">
        <a class="icon fb" href="https://www.facebook.com/eventsandticketsdnepr/" target="_blank"><i class="fa-brands fa-facebook-f"></i></a>
        <a class="icon tg" href="https://t.me/zahodiikvitki" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a class="icon ig" href="#" target="_blank"><i class="fa-brands fa-instagram"></i></a>
        <a class="icon tt" href="#" target="_blank"><i class="fa-brands fa-tiktok"></i></a>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="section">
      <a id="back" href="../afisha.html" class="btn secondary">← Назад</a>
      <h2 id="title" style="margin-top:10px">Вибір місць</h2>

      <!-- Admin Bar -->
      <div id="adminBar" style="display:none; gap:8px; align-items:center; margin:8px 0; padding:8px; border:1px dashed #bbb; border-radius:10px;">
        <strong>Адмін:</strong>
        <button id="btnEvening" class="btn">Вечірній</button>
        <button id="btnKids" class="btn secondary">Дитячий</button>
        <span id="adminStatus" class="meta"></span>
      </div>

      <div class="controls">
        <button id="zoomOut" class="btn secondary">−</button>
        <button id="zoomIn" class="btn">+</button>
        <button id="fitWidth" class="btn">По ширині</button>
        <span id="zoomInfo" class="meta">Масштаб: <strong id="zoomVal">100%</strong></span>
      </div>

      <div id="legend" class="legend"></div>

      <div class="hall-wrap">
        <div id="hall" class="hall" aria-label="Схема залу"></div>
      </div>

      <div id="errorBox" class="error" style="display:none"></div>

      <div style="margin-top:12px">
        <span>Вибрано місць: <strong id="count">0</strong></span> •
        <span>Сума: <strong id="sum">0</strong> грн</span>
        <div><button id="toCheckout" class="btn" disabled>Перейти до оплати</button></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div>© 2025 Ваш Адмін</div>
      <div class="social-icons">
        <a class="icon fb" href="https://www.facebook.com/eventsandticketsdnepr/" target="_blank"><i class="fa-brands fa-facebook-f"></i></a>
        <a class="icon tg" href="https://t.me/zahodiikvitki" target="_blank"><i class="fa-brands fa-telegram"></i></a>
        <a class="icon ig" href="#" target="_blank"><i class="fa-brands fa-instagram"></i></a>
        <a class="icon tt" href="#" target="_blank"><i class="fa-brands fa-tiktok"></i></a>
      </div>
    </div>
  </footer>

  <script type="module">
    import { supabase } from '../scripts/db.js';

    // ====== admin toggle (временный способ через localStorage) ======
    const isAdmin = localStorage.getItem('va_admin') === '1';
    if (isAdmin) document.getElementById('adminBar').style.display = 'flex';

    const qp = new URLSearchParams(location.search);
    const showSlug = qp.get('show'); // theatre/slug
    if (!showSlug) { alert('Помилка: немає параметра ?show'); throw new Error('no show'); }
    const [theatreSlug, showSlugOnly] = showSlug.split('/');

    const rootStyle = document.documentElement.style;
    const zoomValEl = document.getElementById('zoomVal');
    function getSeatPx(){ const v=getComputedStyle(document.documentElement).getPropertyValue('--seat').trim(); return parseInt(v.replace('px','')||'32',10); }
    function setSeatPx(px){ const c=Math.max(16,Math.min(px,56)); rootStyle.setProperty('--seat', c+'px'); zoomValEl.textContent = Math.round(c/32*100)+'%'; document.getElementById('hall').style.transform='scale(1)'; }
    function showError(msg){ const box=document.getElementById('errorBox'); box.style.display='block'; box.textContent=msg; }

    // load show + seats + aisles
    const { data: showRow, error: eShow } = await supabase
      .from('shows')
      .select('id, title, stage, poster_url, venue, date, time, theatres(slug)')
      .eq('slug', showSlugOnly)
      .limit(1)
      .single();
    if (eShow) { showError(eShow.message); throw eShow; }
    const showId = showRow.id;

    document.getElementById('page-title').textContent = 'Схема — ' + showRow.title;
    document.getElementById('title').textContent = `Вибір місць — «${showRow.title}» (${showRow.date} • ${showRow.time})`;
    document.getElementById('back').href = `show.html?show=${encodeURIComponent(showSlug)}`;

    const { data: seats, error: eSeats } = await supabase
      .from('show_seats')
      .select('id, row_label, seat_number, section, price, is_sold')
      .eq('show_id', showId);
    if (eSeats) { showError(eSeats.message); throw eSeats; }

    const { data: rowMeta } = await supabase
      .from('show_row_meta')
      .select('row_label, aisles')
      .eq('show_id', showId);

    const aislesByRow = new Map((rowMeta || []).map(r => [String(r.row_label), r.aisles || []]));
    const hall = document.getElementById('hall');
    const wrap = document.querySelector('.hall-wrap');

    // ==== сцена ====
    const stageEl = document.createElement('div');
    stageEl.className = 'stage';
    stageEl.textContent = 'Сцена';
    hall.appendChild(stageEl);

    // разложим по секциям
    const parter = seats.filter(s=>s.section==='parter');
    const boxLeft = seats.filter(s=>s.section==='box-left' && s.row_label==='A');
    const boxRight= seats.filter(s=>s.section==='box-right' && s.row_label==='B');

    // вычислим макс. кол-во колонок в партере
    const byRow = new Map();
    parter.forEach(s => {
      const key = String(s.row_label);
      if (!byRow.has(key)) byRow.set(key, []);
      byRow.get(key).push(s);
    });

    const maxSeat = (arr)=>arr.reduce((m,s)=>Math.max(m,s.seat_number),0);
    const layoutCols = Math.max(...[...byRow.values()].map(list=>maxSeat(list))) + 1; // + возможные spacers
    hall.style.setProperty('--cols', layoutCols);

    // легенда цен
    const uniquePrices = Array.from(new Set(parter.map(s=>s.price))).sort((a,b)=>b-a);
    const legend = document.getElementById('legend');
    legend.innerHTML = uniquePrices.map(p => `<div class="item"><span class="swatch p-${p}"></span><span>${p} грн</span></div>`).join('');

    let selected=[];

    // рисуем ряды в порядке: 1..N
    const rowNumbers = [...byRow.keys()].map(n=>parseInt(n,10)).sort((a,b)=>a-b);
    rowNumbers.forEach(rn=>{
      const list = (byRow.get(String(rn))||[]).sort((a,b)=>a.seat_number-b.seat_number);
      const aisles = aislesByRow.get(String(rn)) || [];
      let nextA = 0;
      for (let i=0;i<list.length;i++){
        const s = list[i];
        // вставка вертикального прохода (после seat=N ⇒ spacer перед seat=N+1)
        while(nextA<aisles.length && (s.seat_number === aisles[nextA]+1)){
          const sp=document.createElement('div'); sp.className='spacer'; hall.appendChild(sp); nextA++;
        }
        const key = `${s.row_label}-${s.seat_number}`;
        const el = document.createElement('div');
        el.className='seat';
        el.textContent=s.seat_number;
        el.dataset.key=key; el.dataset.row=s.row_label; el.dataset.seat=s.seat_number; el.dataset.price=s.price;
        el.title=`Ряд ${s.row_label}, Місце ${s.seat_number} — ${s.price} грн`;
        if (s.is_sold) el.classList.add('reserved');
        else { el.classList.add('available', `p-${s.price}`); el.addEventListener('click',()=>toggle(el)); }
        hall.appendChild(el);
      }
      const rl=document.createElement('div'); rl.className='rowlabel'; rl.textContent=`Ряд ${rn}`; hall.appendChild(rl);

      if (String(rn)==='18'){ const gap=document.createElement('div'); gap.className='rowgap'; hall.appendChild(gap); }
    });

    // боковые ложи
    function renderBoxGrid(list, title){
      if (!list.length) return null;
      const wrapSide = document.createElement('div'); wrapSide.className='side';
      wrapSide.innerHTML = `<h3>${title}</h3><div class="mini-hall"></div>`;
      const grid = wrapSide.querySelector('.mini-hall');
      const maxSeats = Math.max(...list.map(s=>s.seat_number));
      grid.style.setProperty('--mini-cols', Math.max(6, Math.min(10, maxSeats)));
      list.sort((a,b)=>a.seat_number-b.seat_number).forEach(ss=>{
        const key = `${ss.row_label}-${ss.seat_number}`;
        const el = document.createElement('div');
        el.className='seat';
        el.textContent = ss.seat_number;
        el.dataset.key=key; el.dataset.row=ss.row_label; el.dataset.seat=ss.seat_number; el.dataset.price=ss.price;
        el.title = `Ложа ${ss.row_label==='A'?'А':'Б'}: Місце ${ss.seat_number} — ${ss.price} грн`;
        if (ss.is_sold) el.classList.add('reserved');
        else { el.classList.add('available', `p-${ss.price}`); el.addEventListener('click',()=>toggle(el)); }
        grid.appendChild(el);
      });
      const lab = document.createElement('div'); lab.className='mini-rowlabel'; lab.textContent = title; grid.appendChild(lab);
      return wrapSide;
    }

    const sideRoot = document.createElement('div'); sideRoot.className='side-sections';
    const leftEl  = renderBoxGrid(boxLeft,  'Ложа А');
    const rightEl = renderBoxGrid(boxRight, 'Ложа Б');
    [leftEl,rightEl].forEach(el=>{ if(el) sideRoot.appendChild(el); });
    document.querySelector('main .section').appendChild(sideRoot);

    // ЗУМ и автоподгон
    function fitWidth(){
      const padding = 32;
      const seat = Math.floor((wrap.clientWidth - padding) / layoutCols);
      if (seat >= 16) setSeatPx(seat);
      requestAnimationFrame(()=>{
        const need = wrap.clientWidth - 20;
        const current = hall.scrollWidth;
        const scale = current > 0 ? Math.min(1, need / current) : 1;
        hall.style.transform = `scale(${scale})`;
        document.getElementById('zoomVal').textContent = Math.round(getSeatPx()/32*100*scale)+'%';
        wrap.scrollTop = 0; wrap.scrollLeft = 0;
      });
    }
    document.getElementById('zoomIn').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()+4); });
    document.getElementById('zoomOut').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()-4); });
    document.getElementById('fitWidth').addEventListener('click', fitWidth);
    fitWidth(); setTimeout(fitWidth, 80);

    function toggle(el){
      const key=el.dataset.key;
      const i=selected.findIndex(x=>x.key===key);
      if(i!==-1){selected.splice(i,1); el.classList.remove('selected');}
      else{selected.push({key,row:el.dataset.row,seat:+el.dataset.seat,price:+el.dataset.price}); el.classList.add('selected');}
      const total=selected.reduce((a,b)=>a+b.price,0);
      document.getElementById('count').textContent=selected.length;
      document.getElementById('sum').textContent=total;
      document.getElementById('toCheckout').disabled=selected.length===0;
    }

    document.getElementById('toCheckout').addEventListener('click', async ()=>{
      const seatKeys = selected.map(s => `${s.row}-${s.seat}`); // формат RPC
      // создаём бронь на 10 мин (email можно передать позже на оплате)
      const { data, error } = await supabase.rpc('create_reservation', {
        p_show_slug: showSlugOnly,
        p_seat_keys: seatKeys,
        p_hold_minutes: 10,
        p_email: null
      });
      if (error) { alert('Не вдалося створити бронь: ' + error.message); return; }
      const resId = data;
      const total = selected.reduce((a,b)=>a+b.price,0);
      location.href = `../checkout.html?show=${encodeURIComponent(showSlug)}&res=${resId}&sum=${total}`;
    });

    // Admin pricing
    const adminStatus = document.getElementById('adminStatus');
    async function reprice(profile){
      adminStatus.textContent = 'Оновлюю ціни...';
      const { error } = await supabase.rpc('reprice_show_by_profile', {
        p_show_slug: showSlugOnly,
        p_profile: profile
      });
      if (error) { adminStatus.textContent = 'Помилка: ' + error.message; return; }
      adminStatus.textContent = 'Готово. Перезавантажую схему...';
      location.reload();
    }
    if (isAdmin){
      document.getElementById('btnEvening').addEventListener('click',()=>reprice('evening'));
      document.getElementById('btnKids').addEventListener('click',()=>reprice('kids'));
    }

  </script>
</body>
</html>
