<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Схема залу — Ваш Адмін</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root { --seat: 32px; --gap: 6px; }
    @media (max-width: 640px){ :root { --seat: 22px; --gap: 4px; } }

    /* верхняя панель */
    .controls { position: sticky; top: 0; z-index: 5; background: #fff; padding: 8px 0; margin: -8px 0 8px;
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap; border-bottom: 1px solid #eee; }
    .controls .btn{ padding: 6px 10px; font-size: 14px; }
    .controls .meta{ font-size: 13px; color:#666; }

    /* макет: ложе слева | партер по центру | ложе справа */
    .layout {
      display: grid;
      grid-template-columns: minmax(120px, 1fr) minmax(320px, 6fr) minmax(120px, 1fr);
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 900px){
      .layout { grid-template-columns: 1fr; }
      .loge { order: 2; }  /* на узких экранах боковые ложи уйдут под партер */
      .center { order: 1; }
    }

    /* центр: контейнер с прокруткой ТОЛЬКО у схемы партера */
    .hall-wrap { overflow: auto; border:1px dashed #ddd; border-radius:12px; padding: 12px; max-height: 72vh; background:#fff; width: 100%; }
    .hall { display:grid; gap: var(--gap); justify-content:flex-start; grid-template-columns: repeat(var(--cols, 10), var(--seat)); transform-origin: top left; }

    .stage { grid-column:1/-1; text-align:center; font-weight:700; padding:8px 0; background:#eee; border-radius:8px; margin-bottom:6px }

    .seat { width: var(--seat); height: var(--seat); border-radius:6px; background:#e0e0e0; display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:700; font-size: 12px; user-select: none; }
    .seat.selected{ background:#4caf50; color:#fff }
    .seat.reserved{ background:#9e9e9e; color:#fff; cursor:not-allowed }
    .spacer{ width: var(--seat); height: var(--seat); opacity:0; pointer-events:none }
    .rowlabel{ grid-column:1/-1; text-align:center; color:#666; margin-top:4px; font-size:12px }
    .rowgap{ grid-column:1/-1; height: calc(var(--seat)*1.2); }

    .legend { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .legend .item { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #eee; border-radius:8px; font-size:13px; }
    .legend .swatch { width:16px; height:16px; border-radius:4px; border:1px solid #ddd; }

    /* боковые ложи */
    .loge { background:#fff; border:1px dashed #ddd; border-radius:12px; padding:10px; }
    .loge h3 { margin: 0 0 8px; font-size: 14px; color:#444; text-align:center; }
    .mini { display:grid; gap: var(--gap); grid-template-columns: repeat(var(--mini-cols, 10), calc(var(--seat) * 0.8)); justify-content:center; }
    .mini .seat{ width: calc(var(--seat) * 0.8); height: calc(var(--seat) * 0.8); font-size: 11px; }
    .mini .rowlabel{ font-size: 11px; color:#777; }

    .error { padding: 12px; border:1px solid #fca5a5; background:#fee2e2; color:#7f1d1d; border-radius:10px; margin-top: 8px; display:none; }
  </style>
</head>
<body>
  <header class="header">
    <a id="back" href="../afisha.html">← Назад</a>
    <h2 id="title">Вибір місць</h2>
  </header>

  <div class="container">
    <!-- Кнопки масштаба -->
    <div class="controls">
      <button id="zoomOut" class="btn secondary">−</button>
      <button id="zoomIn" class="btn">+</button>
      <button id="fitWidth" class="btn">По ширині</button>
      <span id="zoomInfo" class="meta">Масштаб: <strong id="zoomVal">100%</strong></span>
    </div>

    <!-- Легенда -->
    <div id="legend" class="legend"></div>

    <!-- Трёхколоночный макет: Ложа A | Партер | Ложа B -->
    <div class="layout">
      <!-- ЛОЖА A (слева) -->
      <aside class="loge" id="logeAbox">
        <h3>Ложа A (ліва)</h3>
        <div id="logeAgrid" class="mini"></div>
      </aside>

      <!-- ПАРТЕР (центр) -->
      <section class="center">
        <div class="hall-wrap">
          <div id="hall" class="hall" aria-label="Схема залу"></div>
        </div>
        <div id="errorBox" class="error"></div>

        <div style="margin-top:12px">
          <span>Вибрано місць: <strong id="count">0</strong></span> •
          <span>Сума: <strong id="sum">0</strong> грн</span>
          <div><button id="toCheckout" class="btn" disabled>Перейти до оплати</button></div>
        </div>
      </section>

      <!-- ЛОЖА B (справа) -->
      <aside class="loge" id="logeBbox">
        <h3>Ложа B (права)</h3>
        <div id="logeBgrid" class="mini"></div>
      </aside>
    </div>
  </div>

  <script type="module">
    const rootStyle = document.documentElement.style;
    const zoomValEl = document.getElementById('zoomVal');
    function getSeatPx(){ const v=getComputedStyle(document.documentElement).getPropertyValue('--seat').trim(); return parseInt(v.replace('px','')||'32',10); }
    function setSeatPx(px){ const c=Math.max(16,Math.min(px,56)); rootStyle.setProperty('--seat', c+'px'); zoomValEl.textContent = Math.round(c/32*100)+'%'; document.getElementById('hall').style.transform='scale(1)'; }
    function showError(msg){ const box=document.getElementById('errorBox'); box.style.display='block'; box.textContent=msg; }

    const qp = new URLSearchParams(location.search);
    const showSlug = qp.get('show'); // e.g. shevchenko/za-dvoma-zaytsiamy
    if (!showSlug) { showError('Немає параметра ?show'); throw new Error('no show'); }

    // Подгружаем JSON описания схемы
    fetch(`../data/shows/${showSlug}.json?ts=${Date.now()}`).then(r=>{
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(show=>{
      document.getElementById('page-title').textContent='Схема — '+show.title;
      document.getElementById('title').textContent='«'+show.title+'»';
      document.getElementById('back').href='../afisha.html';

      const hall = document.getElementById('hall');
      const rows = (show.rows||[]);
      const parter = rows.filter(r => (r.section||'parter')==='parter').sort((a,b)=>a.row-b.row);
      const logeA  = rows.filter(r => r.section==='logeA').sort((a,b)=>a.row-b.row);
      const logeB  = rows.filter(r => r.section==='logeB').sort((a,b)=>a.row-b.row);
      const reserved = new Set(show.reserved || []);

      if (!parter.length) { showError('Немає рядів партера для відображення.'); return; }

      // Легенда цен (по партеру)
      const legend = document.getElementById('legend');
      const prices = Array.from(new Set(parter.map(r=>r.price))).sort((a,b)=>b-a);
      legend.innerHTML = prices.map(p=>`<div class="item"><span class="swatch" style="background:#${(p*1234567).toString(16).slice(0,6)}"></span><span>${p} грн</span></div>`).join('');

      // Кол-во колонок с учётом проходов
      const calcCols = r => (r.seats || 0) + ((r.aisles||[]).length || 0);
      const layoutCols = Math.max(...parter.map(calcCols));
      hall.style.setProperty('--cols', layoutCols);

      // Сцена
      const st = document.createElement('div'); st.className='stage'; st.textContent='Сцена'; hall.appendChild(st);

      // Рендер одного ряда партера (с проходами)
      let selected=[];
      function renderParterRow(cfg){
        const aisles=(cfg.aisles||[]).slice().sort((a,b)=>a-b);
        let nextA=0;
        for(let s=1; s<=cfg.seats; s++){
          while(nextA<aisles.length && (s===aisles[nextA]+1)){
            const sp=document.createElement('div'); sp.className='spacer'; hall.appendChild(sp); nextA++;
          }
          const key=`${cfg.row}-${s}`;
          const el=document.createElement('div');
          el.className='seat'; el.textContent=s;
          el.dataset.key=key; el.dataset.row=cfg.row; el.dataset.seat=s; el.dataset.price=cfg.price;
          el.title=`Ряд ${cfg.row}, Місце ${s} — ${cfg.price} грн`;
          if(reserved.has(key)){ el.classList.add('reserved'); }
          else { el.addEventListener('click',()=>toggle(el)); }
          hall.appendChild(el);
        }
        while(nextA<(cfg.aisles||[]).length){ const sp=document.createElement('div'); sp.className='spacer'; hall.appendChild(sp); nextA++; }
        const rl=document.createElement('div'); rl.className='rowlabel'; rl.textContent=`Ряд ${cfg.row} • ${cfg.price} грн`; hall.appendChild(rl);
      }

      // Партер 1–18, затем зазор, затем 19–21
      parter.forEach(r=>{
        renderParterRow(r);
        if (r.row===18){ const gap=document.createElement('div'); gap.className='rowgap'; hall.appendChild(gap); }
      });

      function toggle(el){
        const key=el.dataset.key;
        const i=selected.findIndex(x=>x.key===key);
        if(i!==-1){selected.splice(i,1); el.classList.remove('selected');}
        else{selected.push({key,row:+el.dataset.row,seat:+el.dataset.seat,price:+el.dataset.price}); el.classList.add('selected');}
        const total=selected.reduce((a,b)=>a+b.price,0);
        document.getElementById('count').textContent=selected.length;
        document.getElementById('sum').textContent=total;
        document.getElementById('toCheckout').disabled=selected.length===0;
      }

      // Рендер боковых лож (мини-сетки) — визуально рядом
      function renderLoge(containerId, list, title){
        const box = document.getElementById(containerId);
        if (!list.length) {
          box.parentElement.style.display = 'none';
          return;
        }
        const grid = box;
        const miniCols = Math.max(...list.map(r=>r.seats||0), 0);
        grid.style.setProperty('--mini-cols', miniCols || 10);

        list.forEach(cfg=>{
          for(let s=1; s<=cfg.seats; s++){
            const el=document.createElement('div');
            el.className='seat';
            el.textContent=s;
            const key=`${cfg.row}-${s}`;
            if(reserved.has(key)) el.classList.add('reserved');
            grid.appendChild(el);
          }
          const rl=document.createElement('div'); rl.className='rowlabel'; rl.textContent=`Рівень ${cfg.row} • ${cfg.price} грн`; grid.appendChild(rl);
        });
      }
      renderLoge('logeAgrid', logeA, 'A');
      renderLoge('logeBgrid', logeB, 'B');

      // Зум/подгон
      const hallWrap = document.querySelector('.hall-wrap');
      function fitWidth(){
        const padding = 32;
        const cols = parseInt(getComputedStyle(hall).getPropertyValue('--cols')) || 10;
        const seat = Math.floor((hallWrap.clientWidth - padding) / cols);
        if (seat >= 16) setSeatPx(seat);
        requestAnimationFrame(()=>{
          const need = hallWrap.clientWidth - 20;
          const cur  = hall.scrollWidth;
          const scale = cur>0 ? Math.min(1, need/cur) : 1;
          hall.style.transform = `scale(${scale})`;
          zoomValEl.textContent = Math.round(getSeatPx()/32*100*scale)+'%';
          hallWrap.scrollTop=0; hallWrap.scrollLeft=0;
        });
      }
      document.getElementById('zoomIn').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()+4); });
      document.getElementById('zoomOut').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()-4); });
      document.getElementById('fitWidth').addEventListener('click', fitWidth);
      fitWidth(); setTimeout(fitWidth, 80);

      // Переход к оплате
      document.getElementById('toCheckout').addEventListener('click',()=>{
        const seats=selected.map(s=>`Р${s.row}-М${s.seat}`).join(',');
        const total=selected.reduce((a,b)=>a+b.price,0);
        location.href=`../checkout.html?show=${encodeURIComponent(showSlug)}&seats=${encodeURIComponent(seats)}&sum=${encodeURIComponent(total)}`;
      });

    }).catch(e=>{
      console.error(e); showError('Не вдалося завантажити схему: '+e.message);
    });
  </script>
</body>
</html>
