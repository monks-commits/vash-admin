<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Схема зала</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root { --seat: 32px; --gap: 6px; } /* базовый размер места */
    @media (max-width: 640px){
      :root { --seat: 22px; --gap: 4px; } /* меньше на телефоне */
    }

    .controls {
      position: sticky; top: 0; z-index: 5;
      background: #fff; padding: 8px 0; margin: -8px 0 8px;
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      border-bottom: 1px solid #eee;
    }
    .controls .btn { padding: 6px 10px; font-size: 14px; }
    .controls .meta { font-size: 13px; color: #666; }

    .hall-wrap{
      overflow: auto;           /* только схема скроллится */
      border:1px dashed #ddd; border-radius:12px; padding: 12px;
      max-height: 72vh;         /* чтобы элементы управления были видны */
      background: #fff;
      width: 100%;
    }

    .hall{
      display:grid; gap: var(--gap);
      justify-content:flex-start;  /* важно для трансформации */
      grid-template-columns: repeat(var(--cols, 10), var(--seat));
      transform-origin: top left;  /* масштабируем от левого верхнего угла */
    }

    .seat{ width: var(--seat); height: var(--seat);
      border-radius:6px; background:#e0e0e0; display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:700; font-size: 12px; user-select: none;
    }
    .seat.selected{ background:#4caf50; color:#fff }
    .seat.reserved{ background:#9e9e9e; color:#fff; cursor:not-allowed }
    .spacer{ width: var(--seat); height: var(--seat); opacity:0; pointer-events:none }
    .rowlabel{ grid-column:1/-1; text-align:center; color:#666; margin-top:4px; font-size:12px }

    .legend { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .legend .item { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #eee; border-radius:8px; font-size:13px; }
    .legend .swatch { width:16px; height:16px; border-radius:4px; border:1px solid #ddd; }

    /* Цвета по цене (правьте под свою палитру) */
    .seat.available{ background:#dbeafe }
    .p-220{ background:#93c5fd } .p-200{ background:#60a5fa }
    .p-190{ background:#a78bfa } .p-180{ background:#8b5cf6 }
    .p-170{ background:#fbbf24 } .p-160{ background:#f472b6 }
    .p-150{ background:#38bdf8 } .p-140{ background:#22c55e }
    .p-130{ background:#10b981 } .p-120{ background:#14b8a6 }
    .p-100{ background:#ef4444 }

    .error {
      padding: 12px; border:1px solid #fca5a5; background:#fee2e2; color:#7f1d1d; border-radius:10px; margin: 10px 0;
    }
  </style>
</head>
<body>
  <header class="header">
    <a id="back" href="../afisha.html">← Назад</a>
    <h2 id="title">Вибір місць</h2>
  </header>

  <div class="container">
    <!-- Управление масштабом -->
    <div class="controls">
      <button id="zoomOut" class="btn secondary">−</button>
      <button id="zoomIn" class="btn">+</button>
      <button id="fitWidth" class="btn">По ширині</button>
      <span id="zoomInfo" class="meta">Масштаб: <strong id="zoomVal">100%</strong></span>
    </div>

    <!-- Легенда цін -->
    <div id="legend" class="legend"></div>

    <!-- Область схемы -->
    <div class="hall-wrap">
      <div id="hall" class="hall" aria-label="Схема залу"></div>
    </div>

    <div id="errorBox" class="error" style="display:none"></div>

    <div style="margin-top:12px">
      <span>Вибрано місць: <strong id="count">0</strong></span> •
      <span>Сума: <strong id="sum">0</strong> грн</span>
      <div><button id="toCheckout" class="btn" disabled>Перейти до оплати</button></div>
    </div>
  </div>

  <script>
  const qp=new URLSearchParams(location.search);
  const showSlug=qp.get('show');
  if(!showSlug){document.body.innerHTML='Помилка: немає параметра ?show';throw new Error('no show');}
  const stageName=s=>s==='big'?'Велика сцена':(s==='small'?'Мала сцена':'');

  const rootStyle = document.documentElement.style;
  const zoomValEl = document.getElementById('zoomVal');
  function getSeatPx(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--seat').trim();
    return parseInt(v.replace('px','')||'32',10);
  }
  function setSeatPx(px){
    const clamped = Math.max(16, Math.min(px, 56)); // 16–56px
    rootStyle.setProperty('--seat', clamped+'px');
    zoomValEl.textContent = Math.round(clamped/32*100)+'%';
    // при изменении размера снимем transform-скейл
    const hall = document.getElementById('hall');
    hall.style.transform = 'scale(1)';
  }

  function showError(msg){
    const box = document.getElementById('errorBox');
    box.style.display = 'block';
    box.textContent = msg;
  }

  fetch(`../data/shows/${showSlug}.json`).then(r=>{
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }).then(show=>{
    document.getElementById('page-title').textContent='Схема — '+show.title;
    document.getElementById('title').textContent='Вибір місць — «'+show.title+'» '+(show.stage?('('+stageName(show.stage)+')'):'');
    document.getElementById('back').href=`show.html?show=${encodeURIComponent(showSlug)}`;

    const allRows=(show.rows||[]).filter(r=>r.enabled!==false);
    const rowsToRender=allRows.filter(r=>(r.section||'parter')!=='balcony'); // сейчас рендерим только партер
    if (!rowsToRender.length){
      showError('Немає активних рядів для відображення.');
      return;
    }

    const hall=document.getElementById('hall');
    const wrap=document.querySelector('.hall-wrap');
    const reserved=new Set(show.reserved||[]);
    const layoutCols=show.layout?.cols || Math.max(...rowsToRender.map(r=>(r.aisles ? (r.seats + r.aisles.length) : r.seats)));
    hall.style.setProperty('--cols', layoutCols);

    // Легенда по ценам
    const uniquePrices = Array.from(new Set(rowsToRender.map(r=>r.price).filter(p=>typeof p==='number'))).sort((a,b)=>b-a);
    const legend = document.getElementById('legend');
    legend.innerHTML = uniquePrices.map(p => `
      <div class="item"><span class="swatch p-${p}"></span><span>${p} грн</span></div>
    `).join('');

    let selected=[];

    rowsToRender.forEach(cfg=>{
      const aisles=(cfg.aisles||[]).slice().sort((a,b)=>a-b);
      let nextA=0;
      for(let s=1;s<=cfg.seats;s++){
        while(nextA<aisles.length && (s===aisles[nextA]+1)){
          const sp=document.createElement('div'); sp.className='spacer'; hall.appendChild(sp); nextA++;
        }
        const key=`${cfg.row}-${s}`;
        const el=document.createElement('div');
        el.className='seat';
        el.textContent=s;
        el.dataset.key=key; el.dataset.row=cfg.row; el.dataset.seat=s; el.dataset.price=cfg.price;
        el.title=`Ряд ${cfg.row}, Місце ${s} — ${cfg.price} грн`;
        if(reserved.has(key)){ el.classList.add('reserved'); }
        else { el.classList.add('available', `p-${cfg.price}`); el.addEventListener('click',()=>toggle(el)); }
        hall.appendChild(el);
      }
      while(nextA<(cfg.aisles||[]).length){ const sp=document.createElement('div'); sp.className='spacer'; hall.appendChild(sp); nextA++; }
      const rl=document.createElement('div'); rl.className='rowlabel'; rl.textContent=`Ряд ${cfg.row} • ${cfg.price} грн`; hall.appendChild(rl);
    });

    // Балкон — просто картинка (если указана)
    if (show.images && show.images.balcony) {
      const img = new Image();
      img.src = show.images.balcony;
      img.alt = 'Балкон';
      img.style.maxWidth = '100%';
      img.style.border = '1px solid #eee';
      img.style.borderRadius = '8px';
      const wrapImg=document.createElement('div'); wrapImg.style.marginTop='16px';
      wrapImg.appendChild(img);
      document.querySelector('.container').appendChild(wrapImg);
    }

    // === Авто-подгон ширины (Double-Fit) ===
    function fitWidth(){
      // 1) подбираем размер места так, чтобы в ширину влезли все колонки
      const padding = 32; // небольшой запас
      const seat = Math.floor((wrap.clientWidth - padding) / layoutCols);
      if (seat >= 16) setSeatPx(seat);

      // 2) на всякий случай докручиваем transform-скейлом
      requestAnimationFrame(()=>{
        const need = wrap.clientWidth - 20; // оставим небольшой зазор
        const current = hall.scrollWidth;
        const scale = current > 0 ? Math.min(1, need / current) : 1;
        hall.style.transform = `scale(${scale})`;
        zoomValEl.textContent = Math.round(getSeatPx()/32*100*scale)+'%';
        wrap.scrollTop = 0; wrap.scrollLeft = 0;
      });
    }

    // Кнопки масштаба
    document.getElementById('zoomIn').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()+4); });
    document.getElementById('zoomOut').addEventListener('click',()=>{ hall.style.transform='scale(1)'; setSeatPx(getSeatPx()-4); });
    document.getElementById('fitWidth').addEventListener('click', fitWidth);

    // Автоматически подгоняем по ширине после первой отрисовки
    // два раза (иногда браузер считает ширину сетки после layout)
    fitWidth();
    setTimeout(fitWidth, 80);

    function toggle(el){
      const key=el.dataset.key;
      const i=selected.findIndex(x=>x.key===key);
      if(i!==-1){selected.splice(i,1); el.classList.remove('selected');}
      else{selected.push({key,row:+el.dataset.row,seat:+el.dataset.seat,price:+el.dataset.price}); el.classList.add('selected');}
      update();
    }
    function update(){
      const total=selected.reduce((a,b)=>a+b.price,0);
      document.getElementById('count').textContent=selected.length;
      document.getElementById('sum').textContent=total;
      document.getElementById('toCheckout').disabled=selected.length===0;
    }
    document.getElementById('toCheckout').addEventListener('click',()=>{
      const seats=selected.map(s=>`Р${s.row}-М${s.seat}`).join(',');
      const total=selected.reduce((a,b)=>a+b.price,0);
      location.href=`../checkout.html?show=${encodeURIComponent(showSlug)}&seats=${encodeURIComponent(seats)}&sum=${encodeURIComponent(total)}`;
    });

  }).catch(e=>{
    console.error(e);
    showError('Не вдалося завантажити схему. Перевірте, чи існує файл даних та шлях: '+
      `data/shows/${showSlug}.json`);
  });
  </script>
</body>
</html>
