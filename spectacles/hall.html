<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Схема зала</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <header class="header">
    <a id="back" href="../afisha.html">← Назад</a>
    <h2 id="title">Вибір місць</h2>
  </header>

  <div class="container">
    <div id="hall" class="hall" aria-label="Схема залу"></div>
    <div style="margin-top:12px">
      <span>Вибрано місць: <strong id="count">0</strong></span> •
      <span>Сума: <strong id="sum">0</strong> грн</span>
      <div><button id="toCheckout" class="btn" disabled>Перейти до оплати</button></div>
    </div>
  </div>

  <script>
    const qp = new URLSearchParams(location.search);
    const slug = qp.get('show');
    const stageName = s => s==='big'?'Велика сцена':(s==='small'?'Мала сцена':'');
    if (!slug) { document.body.innerHTML = 'Помилка: немає параметра ?show'; throw new Error(); }

    fetch(`../data/shows/${slug}.json`).then(r=>r.json()).then(show=>{
      document.getElementById('page-title').textContent = 'Схема — ' + show.title;
      document.getElementById('title').textContent = 'Вибір місць — «' + show.title + '» ' + (show.stage?('('+stageName(show.stage)+')'):'');
      document.getElementById('back').href = `show.html?show=${encodeURIComponent(slug)}`;

      const hall = document.getElementById('hall');
      const reserved = new Set(show.reserved||[]);
      (show.rows||[]).forEach(cfg=>{
        for(let s=1; s<=cfg.seats; s++){
          const key = `${cfg.row}-${s}`;
          const el = document.createElement('div');
          el.className='seat'; el.textContent=s;
          el.dataset.key=key; el.dataset.row=cfg.row; el.dataset.seat=s; el.dataset.price=cfg.price;
          el.title=`Ряд ${cfg.row}, Місце ${s} — ${cfg.price} грн`;
          if(reserved.has(key)){ el.classList.add('reserved'); }
          else { el.addEventListener('click', ()=>toggle(el)); }
          hall.appendChild(el);
        }
      });

      let selected=[];
      function toggle(el){
        const key=el.dataset.key;
        const idx=selected.findIndex(x=>x.key===key);
        if(idx!==-1){ selected.splice(idx,1); el.classList.remove('selected'); }
        else { selected.push({key,row:+el.dataset.row,seat:+el.dataset.seat,price:+el.dataset.price}); el.classList.add('selected'); }
        update();
      }
      function update(){
        const total=selected.reduce((a,b)=>a+b.price,0);
        document.getElementById('count').textContent=selected.length;
        document.getElementById('sum').textContent=total;
        document.getElementById('toCheckout').disabled=selected.length===0;
      }
      document.getElementById('toCheckout').addEventListener('click', ()=>{
        const seats=selected.map(s=>`Р${s.row}-М${s.seat}`).join(',');
        const total=selected.reduce((a,b)=>a+b.price,0);
        location.href = `../checkout.html?show=${encodeURIComponent(slug)}&seats=${encodeURIComponent(seats)}&sum=${encodeURIComponent(total)}`;
      });
    }).catch(e=>{
      document.body.innerHTML = 'Не вдалося завантажити схему.';
      console.error(e);
    });
  </script>
</body>
</html>
