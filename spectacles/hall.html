<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="page-title">Схема залу — Ваш Адмін</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root { --seat: 32px; --gap: 6px; }
    @media (max-width: 640px){ :root { --seat: 22px; --gap: 4px; } }

    .controls {
      position: sticky; top: 0; z-index: 5;
      background: #fff; padding: 8px 0; margin: -8px 0 8px;
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      border-bottom: 1px solid #eee;
    }
    .controls .btn { padding: 6px 10px; font-size: 14px; }
    .controls .meta { font-size: 13px; color: #666; }

    .hall-wrap {
      overflow: auto;
      border:1px dashed #ddd; border-radius:12px; padding: 12px;
      max-height: 72vh;
      background: #fff;
      width: 100%;
    }
    .hall {
      display:grid; gap: var(--gap);
      justify-content:flex-start;
      grid-template-columns: repeat(var(--cols, 10), var(--seat));
      transform-origin: top left;
    }

    .seat {
      width: var(--seat); height: var(--seat);
      border-radius:6px; background:#e0e0e0;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-weight:700; font-size: 12px; user-select: none;
    }
    .seat.selected{ background:#4caf50; color:#fff }
    .seat.reserved{ background:#9e9e9e; color:#fff; cursor:not-allowed }
    .spacer{ width: var(--seat); height: var(--seat); opacity:0; pointer-events:none }
    .rowlabel{ grid-column:1/-1; text-align:center; color:#666; margin-top:4px; font-size:12px }

    .legend { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .legend .item { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #eee; border-radius:8px; font-size:13px; }
    .legend .swatch { width:16px; height:16px; border-radius:4px; border:1px solid #ddd; }

    .error { padding: 12px; border:1px solid #fca5a5; background:#fee2e2; color:#7f1d1d; border-radius:10px; margin: 10px 0; }
  </style>
</head>
<body>
  <header class="header">
    <a id="back" href="../afisha.html">← Назад</a>
    <h2 id="title">Вибір місць</h2>
  </header>

  <div class="container">
    <div class="controls">
      <button id="zoomOut" class="btn secondary">−</button>
      <button id="zoomIn" class="btn">+</button>
      <button id="fitWidth" class="btn">По ширині</button>
      <span id="zoomInfo" class="meta">Масштаб: <strong id="zoomVal">100%</strong></span>
    </div>

    <div id="legend" class="legend"></div>
    <div class="hall-wrap"><div id="hall" class="hall" aria-label="Схема залу"></div></div>
    <div id="errorBox" class="error" style="display:none"></div>

    <div style="margin-top:12px">
      <span>Вибрано місць: <strong id="count">0</strong></span> •
      <span>Сума: <strong id="sum">0</strong> грн</span>
      <div><button id="toCheckout" class="btn" disabled>Перейти до оплати</button></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../scripts/db.js';
    const qp = new URLSearchParams(location.search);
    const showSlug = qp.get('show');
    if (!showSlug) { document.body.innerHTML = '❌ Помилка: відсутній параметр ?show'; throw new Error('no show'); }

    fetch(`../data/shows/${showSlug}.json`).then(r=>r.json()).then(show=>{
      document.getElementById('page-title').textContent='Схема — '+show.title;
      document.getElementById('title').textContent='«'+show.title+'»';
      const allRows = show.rows || [];
      const hall = document.getElementById('hall');
      const reserved = new Set(show.reserved || []);
      const layoutCols = Math.max(...allRows.map(r=>r.seats || 0));
      hall.style.setProperty('--cols', layoutCols);

      const legend = document.getElementById('legend');
      const prices = [...new Set(allRows.map(r=>r.price))].sort((a,b)=>a-b);
      legend.innerHTML = prices.map(p=>`<div class="item"><span class="swatch" style="background:#${Math.floor(Math.random()*16777215).toString(16)}"></span>${p} грн</div>`).join('');

      let selected = [];
      allRows.forEach(row=>{
        for (let s=1; s<=row.seats; s++){
          const key=`${row.row}-${s}`;
          const el=document.createElement('div');
          el.className='seat'; el.textContent=s;
          el.dataset.key=key; el.dataset.row=row.row; el.dataset.price=row.price;
          if (reserved.has(key)) el.classList.add('reserved');
          else el.addEventListener('click',()=>toggle(el,row.price));
          hall.appendChild(el);
        }
        const lbl=document.createElement('div'); lbl.className='rowlabel'; lbl.textContent=`Ряд ${row.row}`; hall.appendChild(lbl);
      });

      function toggle(el,price){
        const k=el.dataset.key; const i=selected.indexOf(k);
        if(i!=-1){selected.splice(i,1); el.classList.remove('selected');}
        else{selected.push(k); el.classList.add('selected');}
        document.getElementById('count').textContent=selected.length;
        document.getElementById('sum').textContent=selected.length*price;
        document.getElementById('toCheckout').disabled=!selected.length;
      }

      document.getElementById('toCheckout').addEventListener('click',()=>{
        const seats=selected.join(',');
        const sum=document.getElementById('sum').textContent;
        location.href=`../checkout.html?show=${encodeURIComponent(showSlug)}&sum=${encodeURIComponent(sum)}&seats=${encodeURIComponent(seats)}`;
      });
    }).catch(e=>{
      const box=document.getElementById('errorBox');
      box.style.display='block';
      box.textContent='Не вдалося завантажити схему: '+e;
    });
  </script>
</body>
</html>
