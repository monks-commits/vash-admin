<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Афіша — Ваш Адмін</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
    .filters .btn{padding:8px 14px;border-radius:10px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;display:grid;grid-template-columns:120px 1fr;gap:14px;align-items:center}
    .poster{width:120px;height:160px;object-fit:cover;border-radius:10px;background:#eee}
    .meta{color:#6b7280;font-size:14px;margin:4px 0 8px}
    .city-chip{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
    .empty{border:1px dashed #ddd;border-radius:12px;padding:14px;background:#fafafa}
  </style>
</head>
<body>
  <header class="header">
    <a class="logo" href="index.html">Ваш Адмін</a>
    <nav class="nav">
      <a href="index.html">Головна</a>
      <a class="active" href="afisha.html">Афіша</a>
      <a href="theatres.html">Театри</a>
      <a href="about.html">Про нас</a>
      <a href="contacts.html">Контакти</a>
    </nav>
  </header>

  <main class="container">
    <h1>Афіша</h1>

    <div class="filters">
      <button class="btn" data-city="all">Всі міста</button>
      <button class="btn secondary" data-city="Дніпро">Дніпро</button>
      <button class="btn secondary" data-city="Кривий Ріг">Кривий Ріг</button>
    </div>

    <div id="list" class="grid"></div>
    <div id="msg" class="empty" style="display:none"></div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div>© 2025 Ваш Адмін</div>
      <div class="footer-links">
        <a target="_blank" href="https://www.facebook.com/eventsandticketsdnepr/">Facebook</a>
        <a target="_blank" href="https://t.me/zahodiikvitki">Telegram</a>
        <a target="_blank" href="https://monks-commits.github.io/music-dnepr/">Музичний Дніпро</a>
        <a target="_blank" href="https://monks-commits.github.io/rock-cafe/">Рок Кафе</a>
      </div>
    </div>
  </footer>

  <script>
  // --- Утиліти ---------------------------------------------------------------
  const byId = (id)=>document.getElementById(id);
  const listEl = byId('list');
  const msgEl  = byId('msg');
  let ALL_ITEMS = [];
  let CURRENT_CITY = 'all';

  // Безпечне читання будь-якого поля з запасними назвами
  const pick = (obj, keys, def='')=>{
    for (const k of keys) if (obj && obj[k]!=null) return obj[k];
    return def;
  };

  // Форматуємо дату
  function fmtDate(iso){
    if(!iso) return '';
    try{
      const d = new Date(iso);
      return d.toLocaleDateString('uk-UA',{day:'2-digit',month:'long',year:'numeric'});
    }catch(e){ return iso; }
  }

  // Створення картки вистави
  function renderCard(item){
    const showPath = pick(item, ['show','slug','show_slug','path'], '');
    const poster   = pick(item, ['poster','image'], '');
    const title    = pick(item, ['title','name'], 'Вистава');
    const theatre  = pick(item, ['theatre','theater','venue'], '');
    const city     = pick(item, ['city'], '');
    const date     = pick(item, ['date','datetime'], '');
    const time     = pick(item, ['time'], '');
    const stage    = pick(item, ['stage'], '');

    // посилання — завжди через show.html
    const hrefShow = `show.html?show=${encodeURIComponent(showPath)}`;

    const div = document.createElement('article');
    div.className = 'card';
    div.innerHTML = `
      <img class="poster" src="${poster}" alt="${title}"
           onerror="this.src='';this.style.display='none'">
      <div>
        <h3 style="margin:0 0 4px">${title}
          ${city ? `<span class="city-chip">${city}</span>` : ''}</h3>
        <div class="meta">
          ${fmtDate(date)}${time ? ' • '+time : ''}
          ${theatre ? ' • '+theatre : ''} ${stage ? ' • '+stage : ''}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="${hrefShow}">Вибрати місця</a>
          <a class="btn secondary" href="${hrefShow}">Детальніше</a>
        </div>
      </div>
    `;
    return div;
  }

  function applyFilter(){
    listEl.innerHTML = '';
    const items = ALL_ITEMS.filter(it => CURRENT_CITY==='all' || (it.city||'').toLowerCase()===CURRENT_CITY.toLowerCase());
    if(items.length===0){
      msgEl.textContent = 'Подій за вибраним фільтром поки немає.';
      msgEl.style.display = 'block';
      return;
    }
    msgEl.style.display = 'none';
    items.forEach(it => listEl.appendChild(renderCard(it)));
  }

  // --- Завантаження афіші ----------------------------------------------------
  async function loadAfisha(){
    try{
      const r = await fetch('data/afisha.json', {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();

      // очікуємо масив подій
      ALL_ITEMS = Array.isArray(data) ? data :
                  Array.isArray(data.items) ? data.items :
                  [];

      // легке сортування — за датою
      ALL_ITEMS.sort((a,b)=>{
        const ad = new Date(pick(a,['date','datetime'],'2099-12-31')).getTime();
        const bd = new Date(pick(b,['date','datetime'],'2099-12-31')).getTime();
        return ad - bd;
      });

      applyFilter();
    }catch(e){
      console.error(e);
      msgEl.style.display = 'block';
      msgEl.textContent = 'Не вдалося завантажити афішу. Перевірте файл data/afisha.json.';
    }
  }

  // --- Фільтри міст ----------------------------------------------------------
  document.querySelectorAll('.filters .btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.filters .btn').forEach(b=>b.classList.add('secondary'));
      btn.classList.remove('secondary');
      CURRENT_CITY = btn.dataset.city || 'all';
      applyFilter();
    });
  });

  loadAfisha();
  </script>
</body>
</html>
