<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Вистава — Ваш Адмін</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .wrap{display:grid;gap:16px}
    @media (min-width:900px){ .wrap{grid-template-columns:280px 1fr} }
    .poster{width:100%;max-width:280px;height:380px;object-fit:cover;border-radius:12px;background:#eee}
    .meta{color:#6b7280;margin:6px 0}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    pre.desc{white-space:pre-wrap;line-height:1.5}
  </style>
</head>
<body>
<header class="header">
  <a href="index.html" class="logo">Ваш Адмін</a>
  <nav class="nav">
    <a href="index.html" class="nav-link">Головна</a>
    <a href="afisha.html" class="nav-link">Афіша</a>
    <a href="theatres.html" class="nav-link">Театри</a>
    <a href="about.html" class="nav-link">Про нас</a>
    <a href="contacts.html" class="nav-link">Контакти</a>
  </nav>
</header>

<main class="container">
  <div id="box" class="card">
    <div id="loading">Завантаження…</div>
    <div id="content" style="display:none">
      <div class="wrap">
        <img id="poster" class="poster" alt="Постер" onerror="this.style.display='none'"/>
        <div>
          <h1 id="title" style="margin:0 0 8px">Вистава</h1>
          <div class="meta" id="when"></div>
          <div class="meta" id="where"></div>
          <div class="meta" id="city"></div>

          <pre id="desc" class="desc" style="margin:14px 0 0"></pre>

          <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap">
            <a id="toHall" class="btn">Вибрати місця</a>
            <a href="afisha.html" class="btn secondary">До афіші</a>
          </div>
        </div>
      </div>
    </div>
    <div id="error" class="meta" style="color:#b91c1c; display:none"></div>
  </div>
</main>

<footer class="footer">
  <div class="footer-inner">
    <div>© 2025 Ваш Адмін</div>
    <div class="footer-links">
      <a href="https://www.facebook.com/eventsandticketsdnepr/" target="_blank">Facebook</a>
      <a href="https://t.me/zahodiikvitki" target="_blank">Telegram</a>
    </div>
  </div>
</footer>

<script>
(async function(){
  const qp = new URLSearchParams(location.search);
  const showSlug = qp.get('show');

  const els = {
    loading: document.getElementById('loading'),
    content: document.getElementById('content'),
    error:   document.getElementById('error'),
    title:   document.getElementById('title'),
    poster:  document.getElementById('poster'),
    when:    document.getElementById('when'),
    where:   document.getElementById('where'),
    city:    document.getElementById('city'),
    desc:    document.getElementById('desc'),
    toHall:  document.getElementById('toHall'),
    pageTitle: document.getElementById('pageTitle'),
  };

  function showError(msg){
    els.loading.style.display='none';
    els.error.textContent = msg;
    els.error.style.display = 'block';
  }
  function normPath(p){
    if (!p) return '';
    if (/^https?:\/\//.test(p)) return p;
    if (p.startsWith('./') || p.startsWith('/')) return p;
    return './' + p;
  }

  if(!showSlug){
    showError('Немає параметра ?show');
    return;
  }
  els.toHall.href = `spectacles/hall.html?show=${encodeURIComponent(showSlug)}`;

  let info = null;
  // detail json (опис/постер/рядки)
  try{
    const r = await fetch(`./data/shows/${showSlug}.json`, {cache:'no-store'});
    if (r.ok) info = await r.json();
  }catch(e){}

  // афиша fallback (постер/мета)
  let fromAfisha = null;
  try{
    const r = await fetch('./data/afisha.json', {cache:'no-store'});
    if (r.ok){
      const arr = await r.json();
      const list = Array.isArray(arr)? arr : (arr?[arr]:[]);
      fromAfisha = list.find(x=>x && x.show === showSlug) || null;
    }
  }catch(e){}

  if (!info && !fromAfisha){
    showError('Не вдалося знайти дані вистави.');
    return;
  }

  const title = (info && info.title) || (fromAfisha && fromAfisha.title) || showSlug.split('/').pop().replace(/-/g,' ');
  els.title.textContent = title;
  els.pageTitle.textContent = title + ' — Ваш Адмін';

  // постер: priority info.poster → info.images.poster → fromAfisha.poster
  const posterPath = normPath(
    (info && (info.poster || (info.images && info.images.poster))) ||
    (fromAfisha && fromAfisha.poster) || ''
  );
  if (posterPath) els.poster.src = posterPath; else els.poster.style.display='none';

  // мета
  const date = (fromAfisha && fromAfisha.date) || (info && info.date) || '';
  const time = (fromAfisha && fromAfisha.time) || (info && info.time) || '';
  const theatre = (fromAfisha && fromAfisha.theatre) || (info && info.theatre) || '';
  const stage = (fromAfisha && fromAfisha.stage) || (info && info.stage) || '';
  const city  = (fromAfisha && fromAfisha.city) || (info && info.city) || '';

  els.when.textContent = [date,time].filter(Boolean).join(' • ');
  els.where.textContent = [theatre, typeof stage==='string'?stage:''].filter(Boolean).join(' • ');
  els.city.textContent  = city;

  els.desc.textContent = (info && info.description) ? info.description : 'Без опису.';

  els.loading.style.display='none';
  els.content.style.display='block';
})();
</script>
</body>
</html>
